<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Malaysian Restaurant</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
<style>
/* ... (Keep all your original CSS styles) ... */
/* Notification Styles */
.notification {
    position: fixed;
    top: 25px;
    right: 25px;
    padding: 18px 28px;
    border-radius: 12px;
    box-shadow: 0 8px 25px rgba(0,0,0,0.25);
    transform: translateX(120%);
    transition: transform 0.4s ease;
    z-index: 3000;
    display: flex;
    align-items: center;
    gap: 12px;
    font-weight: 500;
    color: white; /* Ensure text is readable */
}
.notification.success {
    background: var(--success);
}
.notification.error {
    background: var(--danger); /* Use danger color for errors */
}
.notification.show {
    transform: translateX(0);
}

/* Loading Button Style */
.loading-btn {
    opacity: 0.7;
    cursor: not-allowed;
    pointer-events: none; /* Prevents clicks while loading */
}

/* Add a simple spinner */
.spinner {
    border: 2px solid rgba(255, 255, 255, 0.3);
    border-top: 2px solid white;
    border-radius: 50%;
    width: 16px;
    height: 16px;
    animation: spin 1s linear infinite;
    display: inline-block;
    margin-left: 8px;
    vertical-align: middle;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

</style>
</head>
<body>
<div class="notification" id="notification">
    <i class="fas fa-check-circle"></i> <span id="notification-text">Product added to cart!</span>
</div>
<div class="container">
    <header>
        <h1>Malaysian Restaurant</h1>
        <p class="subtitle">Authentic Malaysian cuisine</p>
    </header>
    <!-- Cart Icon -->
    <div class="cart-container">
        <div class="cart-icon">
            <i class="fas fa-shopping-cart"></i>
            <span class="cart-count">0</span>
        </div>
    </div>
    <!-- Category Filter Bar -->
    <div class="category-filter" id="categoryFilter">
        <!-- Categories will be generated here -->
    </div>
    <!-- Product Grid -->
    <div class="product-grid" id="productGrid">
        <!-- Products will be generated here -->
    </div>
    <!-- Cart Modal -->
    <div class="cart-modal" id="cartModal">
        <div class="cart-header">
            <h3>Your Cart</h3>
            <button id="closeCart"><i class="fas fa-times"></i></button>
        </div>
        <div class="cart-items" id="cartItems">
            <!-- Cart items will be added here -->
        </div>
        <div class="cart-footer">
            <div class="cart-total">
                <span>Total:</span>
                <span id="cartTotal">RM 0.00</span>
            </div>
            <button class="checkout-btn" id="checkoutBtn">Proceed to Checkout</button>
        </div>
    </div>
    <!-- Order Summary Modal -->
    <div class="summary-modal" id="summaryModal">
        <div class="summary-content" id="summaryContent">
            <button class="close-summary" id="closeSummary"><i class="fas fa-times"></i></button>
            <!-- Order Summary Step -->
            <div class="summary-step" id="summaryStep">
                <div class="summary-header">
                    <h3>Order Summary</h3>
                    <p>Please review your order</p>
                </div>
                <div class="summary-details">
                    <table class="summary-table">
                        <thead>
                            <tr>
                                <th>Code</th>
                                <th>Name</th>
                                <th>Price</th>
                                <th>Qty</th>
                                <th>Total</th>
                            </tr>
                        </thead>
                        <tbody id="summaryItems">
                            <!-- Order items will be added here -->
                        </tbody>
                    </table>
                </div>
                <div class="summary-total">
                    <span>Total:</span>
                    <span id="summaryTotal">RM 0.00</span>
                </div>
                <div class="summary-instructions">
                    <!-- Contact info will be dynamically added here -->
                </div>
                <div class="summary-buttons">
                    <button id="backToCartBtn"><i class="fas fa-arrow-left"></i> Back to Cart</button>
                    <button id="screenshotBtn"><i class="fas fa-camera"></i> Capture Screenshot</button>
                    <button id="submitOrderBtn" class="checkout-btn">Submit Order <i class="fas fa-paper-plane"></i></button>
                </div>
            </div>
            <!-- Payment Step -->
            <div class="payment-step" id="paymentStep">
                <div class="payment-header">
                    <h3>Confirm Submission</h3>
                    <p>Order details sent to kitchen.</p>
                </div>
                <div class="qr-container">
                    <div class="qr-code">
                        <i class="fas fa-check-circle fa-5x" style="color: var(--success);"></i> <!-- Placeholder success icon -->
                    </div>
                    <p>Thank you! Your order has been received.</p>
                    <p>Please keep the screenshot sent earlier for your records.</p>
                </div>
                <div class="payment-instructions" id="paymentInstructionsText">
                    A confirmation has been logged.
                </div>
                <div class="payment-buttons">
                    <button id="newOrderBtn"><i class="fas fa-shopping-cart"></i> New Order</button>
                </div>
            </div>
        </div>
    </div>
<script>
// Shopping cart
let cart = [];

// Define GAS Deployment URL HERE
const GAS_DEPLOYMENT_URL = 'YOUR_GAS_WEB_APP_URL_HERE'; // e.g., 'https://script.google.com/macros/s/XXXXXXXXXX/exec'

// Product data (only visible products)
const productData = [
    {"id":100,"title":"Nasi Lemak","description":"Coconut rice with sambal, anchovies, peanuts and boiled egg","category":"Main","productCode":"FOOD-001","price":12.99,"image":"https://images.unsplash.com/photo-1634034379073-f689b460a3fc?crop=entropy&cs=tinysrgb&fit=crop&fm=jpg&h=150&w=150","hidden":false},
    {"id":101,"title":"Char Kway Teow","description":"Stir-fried rice noodles with prawns, eggs, and bean sprouts","category":"Main","productCode":"FOOD-002","price":14.99,"image":"https://images.unsplash.com/photo-1626082927389-6cd097cee6a6?crop=entropy&cs=tinysrgb&fit=crop&fm=jpg&h=150&w=150","hidden":false},
    {"id":102,"title":"Roti Canai","description":"Flaky flatbread served with curry dipping sauce","category":"Side","productCode":"FOOD-003","price":5.99,"image":"https://images.unsplash.com/photo-1628432136678-43ff9be34064?crop=entropy&cs=tinysrgb&fit=crop&fm=jpg&h=150&w=150","hidden":false},
    {"id":103,"title":"Teh Tarik","description":"Sweet pulled milk tea, Malaysia's national drink","category":"Beverage","productCode":"DRINK-004","price":3.99,"image":"https://images.unsplash.com/photo-1629203851122-3726ecdf080e?crop=entropy&cs=tinysrgb&fit=crop&fm=jpg&h=150&w=150","hidden":false}
];

// Categories
const categories = [
    {"id":1,"name":"All","color":"#94a3b8"},
    {"id":2,"name":"Main","color":"#10b981"},
    {"id":3,"name":"Side","color":"#f97316"},
    {"id":4,"name":"Beverage","color":"#0ea5e9"}
];

// Contact information
const contactInfo = {
    email: "orders@restaurant.com", // Replace with actual email
    phone: "+60 12-345 6789"      // Replace with actual number
};

// DOM Elements
const cartIcon = document.querySelector('.cart-icon');
const cartModal = document.getElementById('cartModal');
const cartItems = document.getElementById('cartItems');
const cartTotal = document.getElementById('cartTotal');
const cartCount = document.querySelector('.cart-count');
const closeCart = document.getElementById('closeCart');
const checkoutBtn = document.getElementById('checkoutBtn');
const summaryModal = document.getElementById('summaryModal');
const summaryItems = document.getElementById('summaryItems');
const summaryTotal = document.getElementById('summaryTotal');
const closeSummary = document.getElementById('closeSummary');
const screenshotBtn = document.getElementById('screenshotBtn');
const summaryContent = document.getElementById('summaryContent');
const categoryFilter = document.getElementById('categoryFilter');
const productGrid = document.getElementById('productGrid');
const submitOrderBtn = document.getElementById('submitOrderBtn'); // Changed ID
const paymentStep = document.getElementById('paymentStep');
const summaryStep = document.getElementById('summaryStep');
const newOrderBtn = document.getElementById('newOrderBtn');
const backToCartBtn = document.getElementById('backToCartBtn');
const notification = document.getElementById('notification');
const notificationText = document.getElementById('notification-text');

// Event listeners
cartIcon.addEventListener('click', () => {
    cartModal.classList.add('open');
});

closeCart.addEventListener('click', () => {
    cartModal.classList.remove('open');
});

checkoutBtn.addEventListener('click', () => {
    if (cart.length === 0) {
        showNotification('Your cart is empty!', 'error');
        return;
    }
    cartModal.classList.remove('open');
    showOrderSummary();
});

closeSummary.addEventListener('click', () => {
    summaryModal.style.display = 'none';
    showSummaryStep();
});

screenshotBtn.addEventListener('click', () => {
    captureScreenshot();
});

// NEW: Handle Order Submission
submitOrderBtn.addEventListener('click', async () => {
    if (cart.length === 0) {
        showNotification('Cannot submit an empty order.', 'error');
        return;
    }

    // Disable button and show loading state
    submitOrderBtn.classList.add('loading-btn');
    submitOrderBtn.innerHTML = 'Submitting... <span class="spinner"></span>';

    try {
        const orderData = {
            timestamp: new Date().toISOString(),
            customerContact: `${contactInfo.phone} or ${contactInfo.email}`, // Or prompt user input later
            items: cart.map(item => ({
                code: item.productCode,
                name: item.title,
                price: item.price,
                quantity: item.quantity,
                total: (item.price * item.quantity).toFixed(2)
            })),
            totalAmount: cart.reduce((sum, item) => sum + (item.price * item.quantity), 0).toFixed(2)
        };

        const response = await fetch(GAS_DEPLOYMENT_URL, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(orderData),
        });

        if (response.ok) {
            const result = await response.json();
            console.log('Success:', result);
            showNotification('Order submitted successfully!', 'success');
            showPaymentStep(); // Move to confirmation step
        } else {
            const errorResult = await response.json();
            console.error('Error submitting order:', errorResult);
            showNotification(`Submission failed: ${errorResult.error || 'Server Error'}`, 'error');
        }
    } catch (error) {
        console.error('Network error:', error);
        showNotification('Network error. Please check your connection.', 'error');
    } finally {
        // Re-enable button regardless of outcome
        submitOrderBtn.classList.remove('loading-btn');
        submitOrderBtn.innerHTML = 'Submit Order <i class="fas fa-paper-plane"></i>';
    }
});

// NEW: Handle New Order Button
newOrderBtn.addEventListener('click', startNewOrder);

backToCartBtn.addEventListener('click', () => {
    summaryModal.style.display = 'none';
    cartModal.classList.add('open');
});

// Initialize
renderCategoryFilter();
renderProductGrid();

// Functions
function showNotification(message, type = 'success') { // Added type parameter
    notificationText.textContent = message;
    notification.className = 'notification'; // Reset classes
    notification.classList.add(type, 'show');
    setTimeout(() => {
        notification.classList.remove('show');
    }, 5000); // Increased timeout for errors
}

function renderCategoryFilter() {
    categoryFilter.innerHTML = '';
    categories.forEach(category => {
        const btn = document.createElement('button');
        btn.className = 'category-btn';
        btn.textContent = category.name;
        btn.dataset.category = category.name;
        // Note: Using color might conflict with CSS styling if not handled carefully
        // btn.style.backgroundColor = category.color;
        categoryFilter.appendChild(btn);
        btn.addEventListener('click', () => {
            filterProducts(category.name);
            document.querySelectorAll('.category-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
        });
    });
    // Activate "All" category by default
    if (categories.length > 0) {
        const allBtn = document.querySelector('.category-btn[data-category="All"]');
        if (allBtn) allBtn.classList.add('active');
    }
}

function renderProductGrid() {
    productGrid.innerHTML = '';
    productData.forEach(product => {
        const productCard = document.createElement('div');
        productCard.className = 'product-card';
        productCard.dataset.id = product.id;
        productCard.innerHTML = `
            <img src="${product.image}" alt="${product.title}" class="product-image-preview">
            <div class="product-info">
                <div class="product-title-preview">${product.title}</div>
                <div class="product-description">${product.description}</div>
                <div class="product-category" style="background: ${getCategoryColor(product.category)}">${product.category}</div>
                <div class="product-code">Code: ${product.productCode}</div>
                <div class="product-footer">
                    <div class="product-price-preview">RM ${product.price.toFixed(2)}</div>
                    <button class="add-to-cart" data-id="${product.id}">
                        <i class="fas fa-shopping-cart"></i>
                    </button>
                </div>
            </div>
        `;
        productGrid.appendChild(productCard);

        productCard.addEventListener('click', (e) => {
            if (!e.target.closest('.add-to-cart')) {
                addToCart(product.id);
            }
        });
    });

    document.querySelectorAll('.add-to-cart').forEach(button => {
        button.addEventListener('click', (e) => {
            e.stopPropagation();
            const productId = parseInt(button.dataset.id);
            addToCart(productId);
        });
    });
}

function getCategoryColor(categoryName) {
    const category = categories.find(c => c.name === categoryName);
    return category ? category.color : '#94a3b8';
}

function filterProducts(category) {
    if (category === "All") {
        renderProductGrid();
        return;
    }
    const filteredProducts = productData.filter(product => product.category === category);
    productGrid.innerHTML = '';
    filteredProducts.forEach(product => {
        const productCard = document.createElement('div');
        productCard.className = 'product-card';
        productCard.dataset.id = product.id;
        productCard.innerHTML = `
            <img src="${product.image}" alt="${product.title}" class="product-image-preview">
            <div class="product-info">
                <div class="product-title-preview">${product.title}</div>
                <div class="product-description">${product.description}</div>
                <div class="product-category" style="background: ${getCategoryColor(product.category)}">${product.category}</div>
                <div class="product-code">Code: ${product.productCode}</div>
                <div class="product-footer">
                    <div class="product-price-preview">RM ${product.price.toFixed(2)}</div>
                    <button class="add-to-cart" data-id="${product.id}">
                        <i class="fas fa-shopping-cart"></i>
                    </button>
                </div>
            </div>
        `;
        productGrid.appendChild(productCard);

        productCard.addEventListener('click', (e) => {
            if (!e.target.closest('.add-to-cart')) {
                addToCart(product.id);
            }
        });
    });

    document.querySelectorAll('.add-to-cart').forEach(button => {
        button.addEventListener('click', (e) => {
            e.stopPropagation();
            const productId = parseInt(button.dataset.id);
            addToCart(productId);
        });
    });
}

function addToCart(productId) {
    const product = productData.find(p => p.id === productId);
    if (!product) return;

    const existingItem = cart.find(item => item.id === productId);
    if (existingItem) {
        existingItem.quantity += 1;
    } else {
        cart.push({
            id: product.id,
            title: product.title,
            price: product.price,
            image: product.image,
            productCode: product.productCode,
            quantity: 1
        });
    }
    updateCart();
    showNotification('Added to cart!', 'success');
    cartModal.classList.add('open');
}

function updateCart() {
    const totalItems = cart.reduce((total, item) => total + item.quantity, 0);
    cartCount.textContent = totalItems;

    cartItems.innerHTML = '';
    if (cart.length === 0) {
        cartItems.innerHTML = '<p class="empty-cart">Your cart is empty</p>';
        cartTotal.textContent = 'RM 0.00';
        checkoutBtn.disabled = true;
        checkoutBtn.style.opacity = '0.7';
        return;
    }
    checkoutBtn.disabled = false;
    checkoutBtn.style.opacity = '1';

    let total = 0;
    cart.forEach(item => {
        const itemTotal = item.price * item.quantity;
        total += itemTotal;
        const cartItem = document.createElement('div');
        cartItem.className = 'cart-item';
        cartItem.innerHTML = `
            <img src="${item.image}" alt="${item.title}" class="cart-item-image">
            <div class="cart-item-details">
                <div class="cart-item-title">${item.title}</div>
                <div class="cart-item-price">RM ${item.price.toFixed(2)}</div>
                <div class="cart-item-quantity">
                    <button class="quantity-btn minus" data-id="${item.id}">-</button>
                    <span>${item.quantity}</span>
                    <button class="quantity-btn plus" data-id="${item.id}">+</button>
                </div>
            </div>
            <div class="remove-item" data-id="${item.id}">
                <i class="fas fa-trash"></i>
            </div>
        `;
        cartItems.appendChild(cartItem);
    });

    document.querySelectorAll('.quantity-btn.minus').forEach(button => {
        button.addEventListener('click', () => {
            const id = parseInt(button.dataset.id);
            updateQuantity(id, -1);
        });
    });
    document.querySelectorAll('.quantity-btn.plus').forEach(button => {
        button.addEventListener('click', () => {
            const id = parseInt(button.dataset.id);
            updateQuantity(id, 1);
        });
    });
    document.querySelectorAll('.remove-item').forEach(button => {
        button.addEventListener('click', () => {
            const id = parseInt(button.dataset.id);
            removeFromCart(id);
        });
    });

    cartTotal.textContent = 'RM ' + total.toFixed(2);
}

function updateQuantity(productId, change) {
    const item = cart.find(item => item.id === productId);
    if (!item) return;

    item.quantity += change;
    if (item.quantity <= 0) {
        cart = cart.filter(item => item.id !== productId);
    }
    updateCart();
}

function removeFromCart(productId) {
    cart = cart.filter(item => item.id !== productId);
    updateCart();
}

function showOrderSummary() {
    summaryItems.innerHTML = '';
    let total = 0;
    cart.forEach(item => {
        const itemTotal = item.price * item.quantity;
        total += itemTotal;
        const row = document.createElement('tr');
        row.innerHTML = `
            <td>${item.productCode}</td>
            <td>${item.title}</td>
            <td>RM ${item.price.toFixed(2)}</td>
            <td>${item.quantity}</td>
            <td>RM ${itemTotal.toFixed(2)}</td>
        `;
        summaryItems.appendChild(row);
    });
    summaryTotal.textContent = 'RM ' + total.toFixed(2);

    const instructionsContainer = document.querySelector('.summary-instructions');
    let instructionsHTML = '<p>Please confirm your order. A screenshot was sent earlier.</p>'; // Simplified
    // Removed email/phone from summary, as it's now part of the submission data
    instructionsContainer.innerHTML = instructionsHTML;

    summaryModal.style.display = 'flex';
    showSummaryStep();
}

function showSummaryStep() {
    summaryStep.style.display = 'block';
    paymentStep.style.display = 'none';
}

function showPaymentStep() { // Renamed from showPaymentStep, now handles confirmation
    summaryStep.style.display = 'none';
    paymentStep.style.display = 'block';
    // Confirmation message is now in the HTML template
}

function startNewOrder() {
    cart = []; // Clear the cart array
    updateCart(); // Update the UI
    summaryModal.style.display = 'none'; // Close the modal
    // Optionally, you could redirect or reload the page here
    location.reload(); // Simple way to reset everything, or just re-initialize filters/products
}

function captureScreenshot() {
    html2canvas(summaryContent, {
        backgroundColor: '#16213e'
    }).then(canvas => {
        const link = document.createElement('a');
        link.download = 'order-summary-' + new Date().toISOString().slice(0, 19).replace(/:/g, '-') + '.png';
        link.href = canvas.toDataURL('image/png');
        link.click();
    });
}
</script>
</body>
</html>
